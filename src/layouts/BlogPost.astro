---
import type { CollectionEntry } from 'astro:content';
import BaseLayout from './BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import CopyButton from '../components/CopyButton.astro';
import TableOfContents from '../components/TableOfContents.astro';

type Props = CollectionEntry<'blog'>['data'];

const { title, description, pubDate, updatedDate, heroImage, tags, headings = [] } = Astro.props;
// const { headings } = await Astro.props.post.render(); // 삭제 (여기서 렌더링하면 안됨)
---

<BaseLayout title={title} description={description}>
	<div class="min-h-screen flex flex-col max-w-6xl mx-auto px-4 sm:px-6 border-x border-muted/30 bg-background relative">
		<!-- <Header /> (상세 페이지에서는 헤더 숨김 요청 반영) -->
		
		<div class="flex flex-col xl:flex-row gap-12 relative">
			<main class="flex-1 py-12 min-w-0 w-full overflow-hidden">
				<article class="prose prose-invert prose-neutral max-w-none 
					prose-headings:font-bold prose-headings:tracking-tight prose-headings:scroll-mt-24
					prose-h1:text-2xl sm:text-3xl prose-h1:mb-8 prose-h1:text-accent
					prose-h2:text-xl sm:text-2xl prose-h2:mt-10 prose-h2:mb-4 prose-h2:border-b prose-h2:border-muted/50 prose-h2:pb-2
					prose-p:text-neutral-300 prose-p:leading-7
					prose-pre:bg-[#1e1e1e] prose-pre:border prose-pre:border-muted prose-pre:rounded-lg prose-pre:overflow-x-auto prose-pre:max-w-[calc(100vw-32px)] sm:prose-pre:max-w-none
					prose-code:text-accent prose-code:bg-accent/10 prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:before:content-none prose-code:after:content-none
					prose-img:max-w-full prose-img:h-auto prose-img:rounded-lg
					">
					
					<div class="mb-10 pb-10 border-b border-muted">
						<div class="text-xs font-mono text-neutral-500 mb-4 flex gap-4">
							<FormattedDate date={pubDate} />
							{updatedDate && (
								<div class="italic">
									(Updated: <FormattedDate date={updatedDate} />)
								</div>
							)}
						</div>
						<h1 class="!mb-4">{title}</h1>
						
						{/* Tags */}
						{tags && tags.length > 0 && (
							<div class="flex flex-wrap gap-2 mb-6">
								{tags.map((tag: string) => (
									<span class="text-[10px] border border-accent/30 text-accent px-2 py-0.5 rounded-full uppercase tracking-wider bg-accent/5">
										#{tag}
									</span>
								))}
							</div>
						)}

						<p class="text-xl text-neutral-400 font-light leading-relaxed">{description}</p>
						{heroImage && (
							<img 
								width={1020} 
								height={510} 
								src={`${import.meta.env.BASE_URL}${typeof heroImage === 'string' ? heroImage.replace(/^\//, '') : (heroImage as any).src || ''}`} 
								alt="" 
								class="rounded-lg mt-8 border border-muted w-full" 
							/>
						)}
					</div>

					<slot />
				</article>
			</main>
			
			<aside class="w-64 hidden xl:block relative">
				<TableOfContents headings={headings} />
			</aside>
		</div>

		<Footer />
		<CopyButton />
	</div>
</BaseLayout>
